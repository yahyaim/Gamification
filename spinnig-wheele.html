<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Gift Wheel ‚Äî Weighted Prizes + Tickets</title>
<style>
  :root{--blue:#1E5FA3;--blue-2:#69A6D9;--gold:#F0C04B;--gold-2:#D9A630;--bg:#0e1f33;--text:#F7FAFF}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent} html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
    background:radial-gradient(900px 600px at 50% -10%, #1b3c66 10%, #0e1f33 60%), linear-gradient(180deg,#0e1f33,#0b1828);
  }

  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px}
  .popup{width:min(430px,100%);height:min(800px,96vh);background:linear-gradient(180deg,#112a4d,#0f2240 40%,#0d1c33);
         border-radius:24px;border:1px solid rgba(255,255,255,.06);box-shadow:0 30px 80px rgba(0,0,0,.55),inset 0 0 0 1px rgba(255,255,255,.03);
         overflow:hidden;display:flex;flex-direction:column}
  .head{padding:14px 16px 10px;background:linear-gradient(90deg,rgba(30,95,163,.5),rgba(105,166,217,.25));border-bottom:1px solid rgba(255,255,255,.06)}
  .head h1{margin:0;font-size:18px} .head p{margin:2px 0 0;font-size:12px;opacity:.9}

  .content{flex:1;padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto}
  .card{background:linear-gradient(180deg,#14335d,#102a4e);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:12px;
        box-shadow:0 20px 50px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.03)}
  .row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}

  .stage{position:relative;display:flex;align-items:center;justify-content:center;padding:16px}
  .wheel-wrap{position:relative;width:min(320px,84vw);aspect-ratio:1/1}

  /* Rotor (spins disc + labels together) */
  .rotor{position:absolute;inset:0;transform:rotate(0deg);transition:transform 3.2s cubic-bezier(.12,.2,.03,1);will-change:transform}
  .disc{position:absolute;inset:0;border-radius:50%;z-index:1;
        background:conic-gradient(from -90deg,
          var(--gold) 0 45deg, var(--blue) 45deg 90deg,
          var(--gold-2) 90deg 135deg, var(--blue-2) 135deg 180deg,
          var(--gold) 180deg 225deg, var(--blue) 225deg 270deg,
          var(--gold-2) 270deg 315deg, var(--blue-2) 315deg 360deg);
        border:10px solid rgba(255,255,255,.1);
        box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 20px 40px rgba(0,0,0,.35)}

  /* Labels (emoji) sit ABOVE disc and rotate with rotor */
  .labels{position:absolute;inset:0;z-index:2;list-style:none;margin:0;padding:0;pointer-events:none}
  .labels .tag{
    position:absolute;transform:translate(-50%,-50%);
    font-size:30px;line-height:1;
    font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui,Arial, sans-serif;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.45));
  }
  /* Caption under emoji (small text) */
  .labels .cap{
    position:absolute;transform:translate(-50%,-50%);top:calc(50% + 28px); /* placed below emoji */
    font-size:10px;opacity:.95;letter-spacing:.2px;font-weight:700;white-space:nowrap;
    text-shadow:0 1px 2px rgba(0,0,0,.5);
  }

  /* Center hub */
  .hub{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:3;
       width:84px;height:84px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#cfe7ff,#69A6D9);
       border:4px solid rgba(255,255,255,.18);box-shadow:inset 0 0 0 1px rgba(255,255,255,.4);
       display:flex;align-items:center;justify-content:center;font-size:28px}

  /* Pointer on top */
  .pointer{position:absolute;top:-6px;left:50%;transform:translateX(-50%);z-index:4;
    width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid #ffd56a;
    filter:drop-shadow(0 4px 8px rgba(0,0,0,.5))}
  .pointer-base{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:4;width:18px;height:18px;border-radius:50%;
    background:#0b2036;border:2px solid #ffd56a}

  .controls{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap}
  .btn{padding:10px 12px;border:none;border-radius:14px;font-weight:800;cursor:pointer;color:#0b1424;
       background:linear-gradient(180deg,var(--gold),var(--gold-2));box-shadow:0 10px 24px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.12)}
  .btn.secondary{background:linear-gradient(180deg,#c9e2ff,#69A6D9);color:#06243f}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .tickets{display:flex;align-items:center;gap:8px;font-weight:800}
  .ticket-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
  .ticket-badge i{font-style:normal}

  .result{margin-top:10px;padding:12px;border-radius:14px;text-align:center;font-weight:900;
          background:linear-gradient(180deg,#ffd56a,var(--gold-2));color:#3b2d00;display:none}
  .result.show{display:block}
  .result.win{animation:pop 600ms ease}
  .result.lose{animation:shake 500ms ease}

  @keyframes pop{0%{transform:scale(.85)}60%{transform:scale(1.06)}100%{transform:scale(1)}}
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}
  }

  /* Confetti particles */
  .confetti{position:fixed;inset:0;pointer-events:none;z-index:999}
  .confetti .p{position:absolute;width:8px;height:12px;opacity:.9;border-radius:2px;will-change:transform,opacity}

  /* Win glow on wheel */
  .wheel-win .disc{box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 0 0 6px rgba(240,192,75,.35),0 20px 40px rgba(0,0,0,.35)}
</style>
</head>
<body>
<div class="overlay" role="dialog" aria-modal="true">
  <div class="popup">
    <div class="head">
      <h1>ahlibank rewards wheel</h1>
      <p>Pay a bill to get a ticket. Spin for a chance to win!</p>
    </div>

    <div class="content">
      <section class="card">
        <div class="row">
          <strong>Spin the wheel</strong>
          <div class="tickets">
            <span class="ticket-badge" id="ticketBadge">üéüÔ∏è <i id="ticketCount">0</i></span>
          </div>
        </div>

        <div class="stage">
          <div class="wheel-wrap" id="wheelWrap">
            <div class="pointer"></div><div class="pointer-base"></div>

            <!-- Rotor (spins) -->
            <div id="rotor" class="rotor">
              <div class="disc"></div>
              <ul id="labels" class="labels" aria-hidden="true"></ul>
            </div>

            <!-- Center hub -->
            <div class="hub">üéÅ</div>
          </div>
        </div>

        <div class="controls">
          <button id="payBtn" class="btn secondary">Pay bill ‚Üí Get ticket</button>
          <button id="spinBtn" class="btn" disabled>SPIN</button>
        </div>

        <div id="result" class="result" role="status" aria-live="polite"></div>
      </section>
    </div>
  </div>
</div>

<!-- Confetti layer -->
<div id="confetti" class="confetti" aria-hidden="true"></div>

<script>
(() => {
  // --- Define prizes (edit labels/weights here) -----------------------------
  // type: 'cash' | 'voucher' | 'flight' | 'retry' | 'nothing'
  const PRIZES = [
    { emoji:"üíµ", label:"10 OMR Cash",          type:"cash",    amount:10,       weight: 5 },
    { emoji:"‚õΩÔ∏è", label:"5 OMR Shell Voucher",  type:"voucher", vendor:"Shell", amount:5, weight: 8 },
    { emoji:"üîÅ", label:"Try Again",            type:"retry",                    weight:18 },
    { emoji:"‚àÖ",  label:"Nothing",              type:"nothing",                  weight:22 },
    { emoji:"üíµ", label:"2 OMR Cash",           type:"cash",    amount:2,        weight:16 },
    { emoji:"‚úàÔ∏è", label:"Flight Ticket",        type:"flight",                   weight: 1 },
    { emoji:"üíµ", label:"1 OMR Cash",           type:"cash",    amount:1,        weight:20 },
    { emoji:"üíµ", label:"3 OMR Cash",           type:"cash",    amount:3,        weight:10 },
  ];
  const N = PRIZES.length, SEG = 360 / N;
  const LAB = PRIZES.map(p => p.label);
  const EMO = PRIZES.map(p => p.emoji);

  // Elements
  const rotor = document.getElementById('rotor');
  const list  = document.getElementById('labels');
  const spinBtn = document.getElementById('spinBtn');
  const payBtn  = document.getElementById('payBtn');
  const result  = document.getElementById('result');
  const ticketCountEl = document.getElementById('ticketCount');
  const confettiLayer = document.getElementById('confetti');
  const wheelWrap = document.getElementById('wheelWrap');

  // Tickets
  let tickets = 0;
  function updateTickets(delta=0){
    tickets = Math.max(0, tickets + delta);
    ticketCountEl.textContent = tickets;
    spinBtn.disabled = tickets <= 0 || spinning;
    spinBtn.textContent = tickets>0 ? `SPIN (${tickets})` : 'SPIN';
  }

  // Build emoji + small captions on the wheel
  function buildLabels(){
    list.innerHTML = '';
    const size = list.getBoundingClientRect().width; // equals wheel size
    const r = (size/2) - 34; // room from rim
    for (let i=0;i<N;i++){
      const angleDeg = -90 + i*SEG + SEG/2;  // center of slice, 12 o‚Äôclock reference
      const t = angleDeg * Math.PI / 180;
      const x = Math.cos(t) * r;
      const y = Math.sin(t) * r;

      // emoji
      const span = document.createElement('span');
      span.className = 'tag';
      span.textContent = EMO[i];
      span.style.left = `calc(50% + ${x}px)`;
      span.style.top  = `calc(50% + ${y}px)`;
      list.appendChild(span);

      // caption (short label)
      const cap = document.createElement('span');
      cap.className = 'cap';
      cap.textContent = PRIZES[i].label.replace(' OMR','');
      cap.style.left = span.style.left;
      cap.style.top  = `calc(${span.style.top} + 20px)`;
      list.appendChild(cap);
    }
  }

  // --- Weighted randomness / control ----------------------------------------
  let spinning = false, rotation = 0;
  let forcedIndex = null;                 // if set, next spin is forced to this index
  let weights = null;                     // optional overrides via setWeights()

  function labelToIndex(x){
    if (typeof x === 'number') return ((x % N) + N) % N;
    const i = LAB.findIndex(l => l.toLowerCase() === String(x).toLowerCase());
    if (i === -1) throw new Error(`No slice labeled "${x}".`);
    return i;
  }

  // Compute rotation delta so pointer lands on index i (aiming at center of slice)
  function deltaToIndex(i){
    const current = ((rotation % 360) + 360) % 360;
    const targetAngle = (i * SEG + SEG/2) % 360;
    const targetRotationMod = (360 - targetAngle + 360) % 360;
    let delta = (targetRotationMod - current + 360) % 360;
    const minSpins = 2, safety = 30;
    if (delta < safety) delta += 360;
    delta += minSpins * 360;
    const jitter = (Math.random() * 12 - 6); // +/-6¬∞
    return delta + jitter;
  }

  function pickWeightedIndex(){
    const base = weights
      ? LAB.map(label => Math.max(0, Number(weights[label] ?? 0)))
      : PRIZES.map(p => Math.max(0, Number(p.weight ?? 0)));
    const sum = base.reduce((a,b)=>a+b,0);
    if (sum <= 0) return Math.floor(Math.random() * N);
    const r = Math.random() * sum;
    let acc = 0;
    for (let i=0;i<N;i++){ acc += base[i]; if (r <= acc) return i; }
    return N-1;
  }

  function angleToIndex(finalDeg){
    const a = ((finalDeg % 360) + 360) % 360;
    const pointerAngle = (360 - a + 360) % 360;
    return Math.floor(pointerAngle / SEG);
  }

  // --- Confetti (lightweight) -----------------------------------------------
  function confettiBurst(){
    confettiLayer.innerHTML = '';
    const colors = ['#F0C04B','#69A6D9','#F7FAFF','#ffd56a','#9dd1ff'];
    const count = 100;
    const w = window.innerWidth, h = window.innerHeight;

    for (let i=0;i<count;i++){
      const p = document.createElement('div');
      p.className = 'p';
      const x = Math.random() * w;
      const y = -20; // from top
      const rot = Math.random()*360;
      const scale = 0.8 + Math.random()*0.6;
      const vy = 60 + Math.random()*220;
      const vx = -120 + Math.random()*240;
      const dur = 1200 + Math.random()*1200;
      p.style.left = x+'px';
      p.style.top = y+'px';
      p.style.background = colors[i % colors.length];
      p.style.transform = `translate(0,0) rotate(${rot}deg) scale(${scale})`;
      confettiLayer.appendChild(p);

      const start = performance.now();
      function tick(now){
        const t = Math.min(1, (now - start) / dur);
        const ease = t<.5 ? 2*t*t : -1+(4-2*t)*t; // easeInOutQuad
        const dx = vx * ease;
        const dy = vy * (t*t + t);               // fall faster
        const r = rot + 720*t;
        p.style.transform = `translate(${dx}px, ${dy}px) rotate(${r}deg) scale(${scale})`;
        p.style.opacity = String(1 - t);
        if (t < 1) requestAnimationFrame(tick); else p.remove();
      }
      requestAnimationFrame(tick);
    }
  }

  function clearWinEffects(){
    wheelWrap.classList.remove('wheel-win');
  }

  // --- Spin flow -------------------------------------------------------------
  function spin(){
    if (spinning) return;
    if (tickets <= 0){
      result.textContent = 'You need a ticket to spin. Pay a bill to get one.';
      result.className = 'result show lose';
      return;
    }

    // spend a ticket immediately
    updateTickets(-1);

    spinning = true;
    spinBtn.disabled = true;
    result.className = 'result'; // clear

    const idx = (forcedIndex !== null) ? forcedIndex : pickWeightedIndex();
    forcedIndex = null;

    const delta = deltaToIndex(idx);
    rotation += delta;
    rotor.style.transform = `rotate(${rotation}deg)`;
  }

  rotor.addEventListener('transitionend', (e)=>{
    if(e.propertyName!=='transform') return;
    const idx = angleToIndex(rotation);
    const prize = PRIZES[idx];

    // Determine outcome
    const isWin = (prize.type === 'cash' || prize.type === 'voucher' || prize.type === 'flight');

    // Friendly message
    let msg = '';
    switch(prize.type){
      case 'cash':    msg = `You won ${prize.amount} OMR üí∏`; break;
      case 'voucher': msg = `You won a ${prize.amount} OMR ${prize.vendor} voucher ‚õΩÔ∏è`; break;
      case 'flight':  msg = `Grand prize: ‚úàÔ∏è Flight Ticket!`; break;
      case 'retry':   msg = `Try again! üîÅ`; break;
      case 'nothing': msg = `Nothing this time. ‚àÖ`; break;
      default:        msg = prize.label;
    }

    // UI feedback
    if (isWin){
      result.textContent = `${prize.label} ‚Äî ${msg}`;
      result.className = 'result show win';
      wheelWrap.classList.add('wheel-win');
      confettiBurst();
      setTimeout(clearWinEffects, 1500);
    } else {
      result.textContent = `${msg} (No prize)`;
      result.className = 'result show lose';
      clearWinEffects();
    }

    spinning = false;
    spinBtn.disabled = tickets <= 0;
  });

  // --- Public API (optional) -------------------------------------------------
  const api = {
    rigNext(labelOrIndex){ forcedIndex = labelToIndex(labelOrIndex); return forcedIndex; },
    spinTo(labelOrIndex){ forcedIndex = labelToIndex(labelOrIndex); spin(); },
    setWeights(map){ weights = { ...map }; return weights; },   // { "10 OMR Cash": 2, "Flight Ticket": 1, ... }
    clearWeights(){ weights = null; },
    labels: LAB.slice(),
    prizes: PRIZES.map(p => ({...p})),
    addTickets(n=1){ updateTickets(n); },
  };
  Object.defineProperty(window, 'wheel', { value: api, writable: false });

  // --- Buttons ---------------------------------------------------------------
  payBtn.addEventListener('click', ()=>{
    // simulate a successful bill payment -> grant 1 ticket
    // (if you have real payment logic, call updateTickets(1) after success)
    updateTickets(1);
    result.textContent = 'Payment received ‚úÖ You got a spin ticket!';
    result.className = 'result show win';
    setTimeout(()=>{ if(result.classList.contains('win')) result.classList.remove('win'); }, 600);
  });

  spinBtn.addEventListener('click', spin);
  window.addEventListener('keydown', e=>{ if(e.key===' '){ e.preventDefault(); spin(); } });

  // Build after layout so we have the correct size
  window.addEventListener('load', ()=>{ buildLabels(); updateTickets(0); });
  window.addEventListener('resize', buildLabels);
})();
</script>
</body>
</html>
